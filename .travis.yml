dist: xenial
language: python
sudo: required

services:
  - docker

python:
  - '3.6'
  - '3.7'

install:
  - pip install --upgrade pip setuptools
  - pip install -r requirements-dev.txt

script:
  - make flake
  - make test

before_script:
  # Disable services enabled by default
  # http://docs.travis-ci.com/user/database-setup/#MySQL
  - sudo /etc/init.d/postgresql stop

cache: pip

jobs:
  include:
    - &deploy_job
      stage: Upload a new version of python package to PYPI
      name: Publishing current Git tagged version of dist to PyPI
      if: repo == "aio-libs/create-aio-app" AND tag IS present
      install: []
      script: skip

      before_deploy:
        - pip install --upgrade pep517
        - python -m pep517.build --source --binary --out-dir dist .
        - echo > setup.py

      deploy: &deploy_step
        provider: pypi
        user: __token__
        skip-cleanup: true
        password:
          # Encrypted with `travis encrypt -r aio-libs/create-aio-app --api-endpoint 'https://api.travis-ci.com/'`:
          secure: >-
            IfpGrZVE9XYV2ti/3FeGjoN0OTZNv012yM+btdkQpK23HaeUV3qHh20e8QLqYnr5FYTQmFDExgzY9CVBp9qWsjdr+ZiMRwfW06CQ0WakWfWv7m35X8BUzs2zrYe0nifo9usi3f5fcyDZl7RRBdvdp3tjehkd4IpA4McMDrE0VPb/nwRHddh0IkB8uE0SZ+4gGl6Un5WRJvCzqslNyhow24TycrRBDTxUYiKQRs5LfoSD+yRidznlpJWm4S41naX55aXQqCTY8x7waE47XzmpMosg1KErqH05ag75qVPEs3k24q4ShjsRhPp8duThig0ZKQkSExeB1aeIojJHRl9p7O8rMZY27LagKNlUqhYAJu6ZLBMkCY0nNAM788Co/TNKEe9W+VPpREFyOszEfY0kKeUitsS3uWUv9klX+pTw2YoHUoBImMqT5goSd91jEy2ZovetbI+z6zlVcb2F1rx1jT1hkevzAvbwcaSXM3yEiCAGOmB+4XgJ+rYQD63dnjiJ30E+KarKfDYRq+vt0HYis4OKjyxhwP/3wutWxYk15fjTKNzxDnZc7vPkKrw+iKmZZE9GpUqzeC9k655q/la278OnRxAiLf9Is0d6QVFrqC4IP0+DTIMHNer7UO7dDdcLzpZ3ZrcfU3zsM0qXVxfMIbJcNnzzcGr3HLOgN9hsu9A=
        on:
          all_branches: true
    - <<: *deploy_job
      name: >-
        Publishing current (unstable) Git revision of dist to Test PyPI
        on every push to master
      env:
        PYPI_UPLOAD: true
      if: >-  # Always run, except if PR or cron
        repo == "aio-libs/create-aio-app" AND
        branch == "master" AND
        type == "push"
      deploy:
        <<: *deploy_step
        server: https://test.pypi.org/legacy/
        password:
          secure: >-
            rfpMPtYl0ipSV2ckqiiLPwfx28esAf4zybAGk2imd5zRVI2TudaHPna0mcLQCJ0Rn5rdl3eBdRfTFoFl+V60+5d98SpwE8PCxlY5hAwXd/CirmpjjKj3N8pvIUrs1KHll0gxaMCXEPmEatiWlkF8av4ZUX/ycytQZE3men+Nw4wVMbruKcMoRkTMm1AJ3u1g0lOd4Dr8Gv2mc4vlKvk6a4v8abKsi8mfHOxUDoq5dQdIl+Ghht/eCSb3lGop5o8D1E+7jZv4wj5k2JVpU0ulb7sOKMdzKls0XKINekOroIg3sgIpdzuEyKfW64tIv8PZGYaZrQgb4jIKmwtklbfC6fCY/LkchsdskPO/1QsuLiOIp+JsmAuDfZNZvZu8xSIvmMhmkHPY9ioxZydHWtwvcrfoAXHvCX90v7xlzqqSruAbYfyoZpsDKnJ+FcRVr6x1h+BQHT0kg9k39bGWOyzdJhDt4WaifiM81G5t7zeQTVKiTGWaNRuaE0xFe1kyY4vMYj63snQuAuw8i2zbJ4AubQSHyf4X+9Emgna+/wnNIbVZAaXsf8PJyXP+9JOusGvIg0I3q/cW0v21eXUj4+AIDTXOhdovndurbkHw5otDpRfD4vt0Hdh+YaYmOiOEOh4yBFlnMuQlV5QJwwb50QJDgipExrkYHq7cfNifoPLHWhw=
